<!DOCTYPE html>
<!-- saved from url=(0032)http://www.xfz.cn/post/3292.html -->
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="user-scalable=no,width=device-width,initial-scale=1.0"
	name="viewport">
<title>群星金融姚猛：通过供应链从根本上解决小微企业融资问题_小饭桌_创业从这里起步</title>
<link href="/css/newsDetail.min.css" rel="stylesheet">
<script type="text/javascript" src="/js/jquery.min.js"></script>
</head>

<body device="pc">
	<div class="wrapper" id="wrapper">
		<div class="page-newsDetail">
			<div class="detail" id="newsDetail">
				<div class="detail-content">
					<input type="button" onclick="addPars();" value="添加段落" id="addP"/>
					<input type="button" onclick="preContent();" value="预览"/>
					<div id="para_s">
						<div id="auto_1">
						<div><input type="button" onclick="insertImg(this);" value="插入图片"/></div>
						<div>段落标题<input type="text" placeholder="输入段落标题" class="title" style="width:300px;"/></div>
						<div>段落内容<textarea class="content_pra" style="width:300px;height:200px;"></textarea></div>
						<input type='button' onclick='deletePars(this);' value='删除当前段落'/>
						</div>
					</div>
					<div  style="display: none;">
						<input type="file" name="imgOne" id="imgOne" onchange="preImg(this.id,'imgPre');"/> 
						<img id="imgPre" src=""/>
					</div> 
					<div id="pre_content" class="content-detail">
					</div>
				</div>
			</div>
		</div>
	</div>
	<script type="text/javascript" src="/js/main.js"></script>
	<script>
	var imgData = {};
    function getBase64Image(img) {
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, img.width, img.height);
        var dataURL = canvas.toDataURL("image/png");
        return dataURL // return dataURL.replace("data:image/png;base64,", ""); 
    } 
    function main() { 
        var img = document.createElement('img');
        img.onload =function() { 
            var data = getBase64Image(img); 
            console.log(data); 
        } 
        document.body.appendChild(img); 
    }
    //main();
    function getFileUrl(sourceId) { 
    	var url; 
    	if (navigator.userAgent.indexOf("MSIE")>=1) { // IE 
    	url = document.getElementById(sourceId).value; 
    	} else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox 
    	url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0)); 
    	} else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome 
    	url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0)); 
    	} 
    	return url; 
    	} 
    
    function preImg(sourceId, targetId) { 
    	var url = getFileUrl(sourceId); 
    	var imgPre = document.getElementById(targetId); 
    	imgPre.onload =function() {
    		alert(imgPre.width);
            var data = getBase64Image(imgPre);
            var tmp1 = $("#imgOne").attr("div_id");
            var tmp = $("#" + $("#imgOne").attr("div_id")).find("textarea");
            var pos = $("#" + $("#imgOne").attr("div_id")).find("textarea").getCursorPosition();
    		var curContent = $("#" + $("#imgOne").attr("div_id")).find("textarea").val();
    		$("#" + $("#imgOne").attr("div_id")).find("textarea").val(curContent.substring(0,pos) + 
    				"###IMG###" + $("#imgOne").attr("div_id") + 
    				"###IMG###" + curContent.substring(pos));
            imgData[$("#imgOne").attr("div_id")] = data;
            console.log(data); 
        }
        imgPre.src = url;
    	} 
    var param_index = 2;
    function addPars() {
    	$("#para_s").append("<div id='auto_"+index+"'><div><input type='button' onclick='insertImg(this);' value='插入图片'/></div><div>段落标题<input type='text' placeholder='输入段落标题' class='title' style='width:300px;'/></div><div>段落内容<textarea class='content_pra' style='width:300px;height:200px;'></textarea></div><input type='button' onclick='deletePars(this);' value='删除当前段落'/></div>");
    	param_index ++ ;
    }
    
    function deletePars(ele) {
    	var tmp = $(ele).parent();
    	$(ele).parent().remove();
    }
    function preContent() {
    	$("#pre_content").html("");
    	var tmp = "";
    	$("#para_s input, #para_s textarea").each(function(){
    		if($(this).is("input") && $(this).attr("type") == "button") return true;
    		if($(this).is("input")) {
    			tmp += "<h3>" + $(this).val() + "</h3>";
    		} else {
    			var currentContent = $(this).val();
    			var flag = currentContent.indexOf("###IMG###" + $(this).parent().parent().attr("id")  + "###IMG###");
				if(flag>=0) {
					var testTmp = currentContent.substring(flag + 18);
    				tmp += "<p>" + currentContent.substring(0, flag) + "</p>";
    				tmp += "<p><img src='"+imgData[$(this).parent().parent().attr("id")]+"'></p>";
    				tmp += "<p>" + currentContent.substring(flag + 18 + $(this).parent().parent().attr("id").length) + "</p>";
    			} else {
    				tmp += "<p>" + currentContent + "</p>";
    			}
    		}
    	});
    	$("#pre_content").append(tmp);
    }
    (function($, undefined) {
        $.fn.getCursorPosition = function() {
            var el = $(this).get(0);
            var pos = 0;
            if ('selectionStart' in el) {
                pos = el.selectionStart;
            } else if ('selection' in document) {
                el.focus();
                var Sel = document.selection.createRange();
                var SelLength = document.selection.createRange().text.length;
                Sel.moveStart('character', -el.value.length);
                pos = Sel.text.length - SelLength;
            }
            return pos;
        }
    })(jQuery);
	function insertImg(ele) {
		$("#imgOne").attr("div_id", $(ele).parent().parent().attr("id"));
		$("#imgOne").click();
	}
	</script>
</body>

</html>